name: Run Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Получение кода из репозитория
      - uses: actions/checkout@v4

      # 2. Очистка кэша Maven (ускоряет сборку)
      - name: Clean Maven cache
        run: mvn dependency:purge-local-repository

      # 3. Кэширование Maven зависимостей
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('pom.xml') }}
          restore-keys: |
            maven-

      # 4. Кэширование браузеров Playwright
      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      # 5. Установка Java 17
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 6. Сборка зависимостей проекта
      - name: Resolve dependencies
        run: mvn install -DskipTests

      # 7. Установка браузера Chromium для Playwright
      - name: Install Playwright browsers
        run: mvn exec:java -Dexec.mainClass="com.microsoft.playwright.CLI" -Dexec.args="install chromium"

      # 8. Проверка тестовых файлов
      - name: Check test files
        run: |
          echo "=== Проверка тестовых файлов ==="
          TEST_COUNT=$(find src/test -name "*Test.java" -type f | wc -l)
          if [ "$TEST_COUNT" -eq 0 ]; then
            echo "ERROR: No test files found in src/test!"
            exit 1
          fi
          echo "Found $TEST_COUNT test files:"
          find src/test -name "*Test.java" -type f | head -10
          echo "=== Структура проекта ==="
          ls -la

      # 9. ЗАПУСК ТЕСТОВ с Allure
      - name: Run tests with Allure
        id: run_tests
        run: |
          echo "Starting tests in CI environment..."
          echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
          
          # Запускаем тесты с генерацией Allure отчетов
          mvn clean verify -Dheadless=true -B -DskipTests=false
          
          TESTS_EXIT_CODE=$?
          echo "Tests completed with exit code: $TESTS_EXIT_CODE"
          echo "exit_code=$TESTS_EXIT_CODE" >> $GITHUB_OUTPUT
        env:
          CI: true
          ALLURE_RESULTS_DIR: target/allure-results
          TRACE_ONLY_FAILED: true

      # 10. Проверка созданных файлов
      - name: Check generated files
        if: always()
        run: |
          echo "=== Проверка результатов тестов ==="
          echo "Surefire reports:"
          find target/surefire-reports -name "*.txt" -type f 2>/dev/null | head -5 || echo "No surefire reports"
          
          echo "=== Проверка трейсов ==="
          find target -name "*.zip" -type f 2>/dev/null | head -10 || echo "No trace files found"
          
          echo "=== Проверка Allure результатов ==="
          ALLURE_RESULTS_COUNT=$(find target/allure-results -name "*.json" -type f 2>/dev/null | wc -l || echo "0")
          echo "Allure result files: $ALLURE_RESULTS_COUNT"
          ls -la target/allure-results/ 2>/dev/null || echo "No allure results directory"

      # 11. Установка Allure CLI
      - name: Install Allure CLI
        if: always()
        run: |
          echo "Installing Allure CLI v2.24.0..."
          sudo wget -q -O /tmp/allure.tgz https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.tgz
          sudo tar -xzf /tmp/allure.tgz -C /opt/
          sudo ln -sf /opt/allure-2.24.0/bin/allure /usr/local/bin/allure
          allure --version

      # 12. Генерация HTML отчета Allure
      - name: Generate Allure Report
        if: always()
        run: |
          echo "Generating Allure report..."
          allure generate target/allure-results -o allure-report --clean
          echo "Allure report size:"
          du -sh allure-report/

      # 13. Загрузка Allure отчета как артефакта
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/

      # 14. Загрузка трейсов для упавших тестов
      - name: Upload failed test traces
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-failed
          path: target/traces-failed-only/
          if-no-files-found: ignore

      # 15. Загрузка всех трейсов (для отладки)
      - name: Upload all traces (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces-all
          path: target/traces-all/
          if-no-files-found: ignore

      # 16. Загрузка сырых результатов тестов
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/

      # 17. Итоговая информация
      - name: Test summary
        if: always()
        run: |
          echo "=== TEST EXECUTION SUMMARY ==="
          echo "Test exit code: ${{ steps.run_tests.outputs.exit_code }}"
          echo "Workflow result: ${{ job.status }}"
          
          # Подсчет упавших тестов
          FAILED_TESTS=$(find target/surefire-reports -name "*.txt" -exec grep -l "FAILURE\|ERROR" {} \; 2>/dev/null | wc -l || echo "0")
          echo "Failed tests: $FAILED_TESTS"
          
          # Информация о сохраненных трейсах
          FAILED_TRACES=$(find target/traces-failed-only -name "*.zip" -type f 2>/dev/null | wc -l || echo "0")
          echo "Traces saved for failed tests: $FAILED_TRACES"
          
          # Предупреждение если трейсы не создались
          if [ "$FAILED_TESTS" -gt 0 ] && [ "$FAILED_TRACES" -eq 0 ]; then
            echo "::warning::Tests failed but no traces were saved! Check Traceable implementation."
          fi
          
          # Если тесты упали, но не критично для workflow
          if [ "${{ steps.run_tests.outputs.exit_code }}" -ne 0 ]; then
            echo "::warning::Some tests failed. Check artifacts for details."
          fi
          
          echo "=== Доступные артефакты ==="
          echo "1. allure-report - HTML отчет Allure"
          echo "2. playwright-traces-failed - трейсы упавших тестов"
          echo "3. playwright-traces-all - все трейсы"
          echo "4. test-results - сырые результаты тестов"
